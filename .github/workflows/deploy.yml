name: Deploy to Linode

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test --verbose

      - name: Build release
        run: cargo build --release --verbose

  deploy:
    name: Deploy to Linode
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binary
        run: cargo build --release

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp target/release/pingora-proxy deploy/
          cp pingora-proxy.service deploy/
          cp .env.example deploy/
          cp deploy.sh deploy/
          cp 01-netcfg.yaml deploy/
          tar czf pingora-proxy-deploy.tar.gz -C deploy .

      - name: Install the Linode CLI
        uses: linode/action-linode-cli@v1
        with:
          token: ${{ secrets.LINODE_TOKEN }}

      - name: Get Linode instance details
        id: instance
        run: |
          # Get instance IP using Linode CLI
          INSTANCE_ID="${{ secrets.LINODE_INSTANCE_ID }}"

          # Fetch instance details
          INSTANCE_DATA=$(linode-cli linodes view $INSTANCE_ID --json)

          # Extract IP address
          IP=$(echo "$INSTANCE_DATA" | jq -r '.[0].ipv4[0]')
          STATUS=$(echo "$INSTANCE_DATA" | jq -r '.[0].status')
          LABEL=$(echo "$INSTANCE_DATA" | jq -r '.[0].label')

          if [ -z "$IP" ] || [ "$IP" = "null" ]; then
            echo "❌ Error: Could not find instance with ID $INSTANCE_ID"
            exit 1
          fi

          echo "✅ Found instance: $LABEL"
          echo "   Status: $STATUS"
          echo "   IP: $IP"

          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.LINODE_SSH_KEY }}
          SSH_HOST: ${{ steps.instance.outputs.ip }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to Linode
        env:
          SSH_HOST: ${{ steps.instance.outputs.ip }}
          SSH_USER: ${{ secrets.LINODE_USER }}
        run: |
          # Upload deployment package
          scp pingora-proxy-deploy.tar.gz $SSH_USER@$SSH_HOST:/tmp/

          # Deploy on server
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e

            echo "Stopping service..."
            sudo systemctl stop pingora-proxy || true

            echo "Extracting files..."
            cd /opt/pingora-proxy
            tar xzf /tmp/pingora-proxy-deploy.tar.gz

            echo "Setting permissions..."
            chmod +x pingora-proxy
            chmod +x deploy.sh

            echo "Installing service..."
            sudo cp pingora-proxy.service /etc/systemd/system/
            sudo systemctl daemon-reload
            sudo systemctl enable pingora-proxy

            echo "Starting service..."
            sudo systemctl start pingora-proxy

            echo "Checking status..."
            sudo systemctl status pingora-proxy --no-pager

            echo "Deployment complete!"
          ENDSSH

      - name: Verify deployment
        env:
          SSH_HOST: ${{ steps.instance.outputs.ip }}
          SSH_USER: ${{ secrets.LINODE_USER }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            sleep 3
            if sudo systemctl is-active --quiet pingora-proxy; then
              echo "✅ Service is running"
              sudo journalctl -u pingora-proxy -n 20 --no-pager
            else
              echo "❌ Service failed to start"
              sudo journalctl -u pingora-proxy -n 50 --no-pager
              exit 1
            fi
          ENDSSH

      - name: Cleanup
        if: always()
        env:
          SSH_HOST: ${{ steps.instance.outputs.ip }}
          SSH_USER: ${{ secrets.LINODE_USER }}
        run: |
          ssh $SSH_USER@$SSH_HOST 'rm -f /tmp/pingora-proxy-deploy.tar.gz' || true
